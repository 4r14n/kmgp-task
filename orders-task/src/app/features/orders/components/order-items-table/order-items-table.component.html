<div class="order-items-table">
  <p-table [value]="itemsFormArray().controls" class="p-datatable-sm">
    <ng-template #header>
      <tr>
        <th>Наименование товара</th>
        <th style="width: 150px">Количество</th>
        <th style="width: 150px">Цена за ед.</th>
        <th style="width: 150px">Сумма</th>
        @if (!readonly()) {
          <th style="width: 100px">Действия</th>
        }
      </tr>
    </ng-template>
    <ng-template #body let-control let-rowIndex="rowIndex">
      <tr [formGroup]="getItemFormGroup(rowIndex)">
        <td>
          <input
            pInputText
            formControlName="productName"
            [readonly]="readonly()"
            [class.p-invalid]="hasError(rowIndex, 'productName')"
            placeholder="Введите название товара"
            class="w-full"
          />
          @if (hasError(rowIndex, 'productName')) {
            <small class="p-error">{{ getErrorMessage(rowIndex, 'productName') }}</small>
          }
        </td>
        <td>
          <p-inputnumber
            formControlName="qty"
            [readonly]="readonly()"
            [showButtons]="!readonly()"
            [min]="1"
            [step]="1"
            [class.p-invalid]="hasError(rowIndex, 'qty')"
            placeholder="1"
            class="w-full"
          />
          @if (hasError(rowIndex, 'qty')) {
            <small class="p-error">{{ getErrorMessage(rowIndex, 'qty') }}</small>
          }
        </td>
        <td>
          <p-inputnumber
            formControlName="price"
            [readonly]="readonly()"
            [showButtons]="!readonly()"
            [min]="0.01"
            [step]="0.01"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            mode="decimal"
            locale="ru-RU"
            [class.p-invalid]="hasError(rowIndex, 'price')"
            placeholder="0.00"
            class="w-full"
          />
          @if (hasError(rowIndex, 'price')) {
            <small class="p-error">{{ getErrorMessage(rowIndex, 'price') }}</small>
          }
        </td>
        <td>
          <strong>{{ calculateItemTotal(rowIndex) | currency: 'KZT':'symbol':'1.2-2':'ru-RU' }}</strong>
        </td>
        @if (!readonly()) {
          <td>
            <p-button
              icon="pi pi-trash"
              severity="danger"
              [text]="true"
              [rounded]="true"
              (onClick)="onRemoveItem(rowIndex)"
              pTooltip="Удалить товар"
              tooltipPosition="top"
            />
          </td>
        }
      </tr>
    </ng-template>
  </p-table>

  @if (!readonly()) {
    <div class="mt-3">
      <p-button
        label="Добавить товар"
        icon="pi pi-plus"
        severity="secondary"
        [outlined]="true"
        (onClick)="onAddItem()"
      />
    </div>
  }
</div>
